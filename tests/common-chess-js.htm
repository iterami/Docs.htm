<!doctype html>
<meta charset=utf-8>
<meta content="width=device-width,initial-scale=1" name=viewport>
<title>common chess.js Tests</title>
<link href=../../common/css/core.css rel=stylesheet>
<link href=../../common/css/chess.css rel=stylesheet>
<style>
.taken{
    background: #fff;
    color: #000;
}
</style>

<a href=../../index.htm>iterami</a>/<a href=../index.htm>Docs.htm</a>/<a href=../repos/index.htm>Repo</a> Tests/<a href=../../common/index.htm>common</a>/<a href=../../common/js/chess.js>chess.js</a>
<table class="center chess" id=board></table>
<span class=big>
  <span class=taken id=black-pieces-taken></span>
  <span id=turn></span>'s turn
  <span class=taken id=white-pieces-taken></span>
</span><br>
<input onclick="reset_board(true)" type=button value=Reset><input onclick="update_board()" type=button value=Update><br>
en passant: <span id=en-passant></span><br>
Black pawn promote: <select id=black-pawn-promote>
  <option value=2>Bishop</option>
  <option value=1>Knight</option>
  <option value=4 selected>Queen</option>
  <option value=3>Rook</option>
</select><br>
White pawn promote: <select id=white-pawn-promote>
  <option value=2>Bishop</option>
  <option value=1>Knight</option>
  <option value=4 selected>Queen</option>
  <option value=3>Rook</option>
</select><br>
Black king moved: <span id=black-king-moved></span><br>
White king moved: <span id=white-king-moved></span>

<script src=../../common/js/chess.js></script>
<script>
function select_square(id){
    if(selected_x > -1){
        document.getElementById(selected_y + '-' + selected_x).style.color = '#000';
    }

    const square_x = Number(id[2]);
    const square_y = Number(id[0]);

    if(selected_x === square_x && selected_y === square_y){
        selected_x = -1;
        selected_y = -1;

    }else if(selected_x === -1 || selected_y === -1){
        if(chess_games['test']['board'][square_y - 1][square_x - 1].length === 1){
            selected_x = square_x;
            selected_y = square_y;
        }

    }else if(chess_move({
        'id': 'test',
        'piece-x': selected_x,
        'piece-y': selected_y,
        'target-x': square_x,
        'target-y': square_y,
      })){
        selected_x = -1;
        selected_y = -1;
        update_board();

    }else{
        selected_x = -1;
        selected_y = -1;
    }

    if(selected_x > -1){
        document.getElementById(selected_y + '-' + selected_x).style.color = '#0a0';
    }
}

function reset_board(reset){
    if(reset && !globalThis.confirm('Reset the entire board?')){
        return false;
    }

    chess_new({
      'id': 'test',
    });
    selected_x = -1;
    selected_y = -1;
    update_board();
}

function update_board(){
    chess_games['test']['players'][1]['pawn-promote'] = Number(document.getElementById('black-pawn-promote').value);
    chess_games['test']['players'][0]['pawn-promote'] = Number(document.getElementById('white-pawn-promote').value);

    document.getElementById('black-king-moved').textContent = chess_games['test']['players'][1]['king-moved'];
    document.getElementById('black-pieces-taken').textContent = chess_games['test']['players'][1]['pieces-taken'];
    document.getElementById('en-passant').textContent = chess_games['test']['en-passant'] > -1
      ? chess_games['test']['en-passant']
      : '';
    document.getElementById('turn').textContent = chess_games['test']['player']
      ? 'Black'
      : 'White';
    document.getElementById('white-king-moved').textContent = chess_games['test']['players'][0]['king-moved'];
    document.getElementById('white-pieces-taken').textContent = chess_games['test']['players'][0]['pieces-taken'];
    for(let y = 1; y < 9; y++){
        for(let x = 1; x < 9; x++){
            document.getElementById(y + '-' + x).innerHTML = chess_games['test']['board'][y - 1][x - 1] || '&nbsp;';
        }
    }
}

let selected_x = -1;
let selected_y = -1;

let board_html = '';
for(let y = 1; y < 9; y++){
    board_html += '<tr>';
    for(let x = 1; x < 9; x++){
        board_html += '<td id="' + y + '-' + x + '" onclick="select_square(this.id)">';
    }
}
document.getElementById('board').innerHTML = board_html;

reset_board(false);
</script>
